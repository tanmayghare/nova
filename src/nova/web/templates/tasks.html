{% extends "base.html" %}

{% block title %}Tasks - Nova Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">Tasks</h1>
        <a href="/new_task" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
            New Task
        </a>
    </div>

    <div class="grid grid-cols-1 gap-6">
        <!-- Active Tasks -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Active Tasks</h2>
            <div id="active-tasks" class="space-y-4">
                {% for task in tasks %}
                {% if task.status in ['pending', 'running'] %}
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-medium">{{ task.task }}</h3>
                            <p class="text-sm text-gray-500">Created: {{ task.created_at }}</p>
                            <p class="text-sm text-gray-500">Status: {{ task.status }}</p>
                        </div>
                        <span class="px-2 py-1 rounded text-sm
                            {% if task.status == 'pending' %}bg-yellow-100 text-yellow-800
                            {% elif task.status == 'running' %}bg-blue-100 text-blue-800
                            {% endif %}">
                            {{ task.status }}
                        </span>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Completed Tasks -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Completed Tasks</h2>
            <div id="completed-tasks" class="space-y-4">
                {% for task in tasks %}
                {% if task.status in ['completed', 'failed'] %}
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-medium">{{ task.task }}</h3>
                            <p class="text-sm text-gray-500">Created: {{ task.created_at }}</p>
                            <p class="text-sm text-gray-500">Completed: {{ task.completed_at }}</p>
                            <p class="text-sm text-gray-500">Status: {{ task.status }}</p>
                            {% if task.llm_response %}
                            <div class="mt-2">
                                <h4 class="font-medium text-sm">LLM Response:</h4>
                                <pre class="bg-gray-50 p-2 rounded text-sm overflow-x-auto">{{ task.llm_response }}</pre>
                            </div>
                            {% endif %}
                            {% if task.result %}
                            <div class="mt-2">
                                <h4 class="font-medium text-sm">Result:</h4>
                                <pre class="bg-gray-50 p-2 rounded text-sm overflow-x-auto">{{ task.result }}</pre>
                            </div>
                            {% endif %}
                            {% if task.error %}
                            <div class="mt-2">
                                <h4 class="font-medium text-sm text-red-600">Error:</h4>
                                <pre class="bg-red-50 p-2 rounded text-sm text-red-600 overflow-x-auto">{{ task.error }}</pre>
                            </div>
                            {% endif %}
                        </div>
                        <span class="px-2 py-1 rounded text-sm
                            {% if task.status == 'completed' %}bg-green-100 text-green-800
                            {% elif task.status == 'failed' %}bg-red-100 text-red-800
                            {% endif %}">
                            {{ task.status }}
                        </span>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh active tasks every 5 seconds
setInterval(async () => {
    const response = await fetch('/api/tasks');
    const tasks = await response.json();
    
    // Update active tasks
    const activeTasksDiv = document.getElementById('active-tasks');
    const completedTasksDiv = document.getElementById('completed-tasks');
    
    // Clear existing content
    activeTasksDiv.innerHTML = '';
    completedTasksDiv.innerHTML = '';
    
    // Add tasks to appropriate sections
    tasks.forEach(task => {
        const taskElement = createTaskElement(task);
        if (task.status === 'pending' || task.status === 'running') {
            activeTasksDiv.appendChild(taskElement);
        } else {
            completedTasksDiv.appendChild(taskElement);
        }
    });
}, 5000);

function createTaskElement(task) {
    const div = document.createElement('div');
    div.className = 'border rounded-lg p-4';
    
    const statusClass = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'running': 'bg-blue-100 text-blue-800',
        'completed': 'bg-green-100 text-green-800',
        'failed': 'bg-red-100 text-red-800'
    }[task.status];
    
    div.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <h3 class="font-medium">${task.task}</h3>
                <p class="text-sm text-gray-500">Created: ${task.created_at}</p>
                <p class="text-sm text-gray-500">Status: ${task.status}</p>
                ${task.completed_at ? `<p class="text-sm text-gray-500">Completed: ${task.completed_at}</p>` : ''}
                ${task.llm_response ? `
                    <div class="mt-2">
                        <h4 class="font-medium text-sm">LLM Response:</h4>
                        <pre class="bg-gray-50 p-2 rounded text-sm overflow-x-auto">${task.llm_response}</pre>
                    </div>
                ` : ''}
                ${task.result ? `
                    <div class="mt-2">
                        <h4 class="font-medium text-sm">Result:</h4>
                        <pre class="bg-gray-50 p-2 rounded text-sm overflow-x-auto">${task.result}</pre>
                    </div>
                ` : ''}
                ${task.error ? `
                    <div class="mt-2">
                        <h4 class="font-medium text-sm text-red-600">Error:</h4>
                        <pre class="bg-red-50 p-2 rounded text-sm text-red-600 overflow-x-auto">${task.error}</pre>
                    </div>
                ` : ''}
            </div>
            <span class="px-2 py-1 rounded text-sm ${statusClass}">
                ${task.status}
            </span>
        </div>
    `;
    
    return div;
}
</script>
{% endblock %} 